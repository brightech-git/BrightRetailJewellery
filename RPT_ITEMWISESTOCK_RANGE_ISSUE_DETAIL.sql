alter PROCEDURE [dbo].[RPT_ITEMWISESTOCK_RANGE_ISSUE_DETAIL]                
(                 
@DBNAME VARCHAR(100)                
,@FRMDATE VARCHAR(12)                
,@TODATE VARCHAR(12)                   
,@METALID VARCHAR(100)                   
,@CATCODE VARCHAR(1000)                     
,@ITEMTYPE VARCHAR(100)                  
,@ITEMIDS VARCHAR(500)                
,@ITEMTYPEIDS VARCHAR(500)                
,@DESIGNERIDS VARCHAR(200)                
,@COMPANYID VARCHAR(50)                 
,@COUNTERIDS VARCHAR(500)                
,@COSTIDS VARCHAR(200)                 
,@SYSTEMID VARCHAR(10)                
,@TAGTYPE VARCHAR(1)                
,@WITHSUBITEM VARCHAR(1)                
,@WITHDIA VARCHAR(1)                
,@WITHSTONE VARCHAR(1)                
,@RANGE VARCHAR(500)                
,@WITHRANGEOUT VARCHAR(1)                
,@RPTBASED VARCHAR(1)                
,@TRANONLY VARCHAR(1)              
,@ISSUEONLY VARCHAR(1)  
)                
AS                  
BEGIN /** PROC STARTS **/                  
SET NOCOUNT ON                
DECLARE @QRY VARCHAR(8000)                 
DECLARE @SQLQRY NVARCHAR(4000)                     
DECLARE @ITEMFILTER VARCHAR(1000)                
DECLARE @TAGFILTER VARCHAR(1000)                
DECLARE @DESFILTER VARCHAR(1000)                
DECLARE @RECDATE VARCHAR(20)                
DECLARE @REGORDFILTER VARCHAR(50)                
SET @REGORDFILTER = ''                
SET @CATCODE = REPLACE(@CATCODE,',',''',''')                
SET @COUNTERIDS = REPLACE(@COUNTERIDS,',',''',''')                
SET @DESIGNERIDS = REPLACE(@DESIGNERIDS,',',''',''')                   
SET @METALID = REPLACE(@METALID,',',''',''')                  
SET @RANGE = REPLACE(@RANGE,',',''',''')                
IF OBJECT_ID('TEMPDB..#DESIGNERS') IS NOT NULL DROP TABLE #DESIGNERS                
CREATE TABLE #DESIGNERS(DESIGNERID INT)                     
IF OBJECT_ID('TEMPDB..#ITEMCTR') IS NOT NULL DROP TABLE #ITEMCTR                 
CREATE TABLE #ITEMCTR(CTRID INT )                     
IF OBJECT_ID('TEMPTABLEDB..TEMPITEMIDS') IS NOT NULL DROP TABLE TEMPTABLEDB..TEMPITEMIDS                 
CREATE TABLE TEMPTABLEDB..TEMPITEMIDS(ITEMID INT)                     
EXEC(@QRY)                
SET @RECDATE='T.RECDATE'                
SET @ITEMFILTER='' /** ITEM FILTER**/                 
SET @ITEMFILTER= @ITEMFILTER +' I.ITEMID IN(SELECT ITEMID FROM ITEMMAST WHERE ISNULL(STOCKREPORT,'''')<>''N'' )'                
IF @METALID <> '' SET @ITEMFILTER= @ITEMFILTER +' AND I.ITEMID IN(SELECT ITEMID FROM ITEMMAST WHERE METALID IN('''+@METALID+'''))'                
IF @CATCODE <> 'ALL' SET @ITEMFILTER= @ITEMFILTER +' AND I.ITEMID IN(SELECT ITEMID FROM ITEMMAST WHERE CATCODE IN('''+@CATCODE +'''))'                
SET @ITEMTYPE = REPLACE(@ITEMTYPE,',',''',''')                  
IF @ITEMTYPE<>'' SET @ITEMFILTER= @ITEMFILTER +' AND I.ITEMID IN(SELECT ITEMID FROM ITEMMAST WHERE CALTYPE IN('''+@ITEMTYPE+'''))'                
IF @ITEMIDS <> '' SET @ITEMFILTER= @ITEMFILTER + ' AND I.ITEMID IN('+@ITEMIDS+')'                
SET @QRY = ''                  
SELECT @QRY=' INSERT INTO TEMPTABLEDB..TEMPITEMIDS(ITEMID) SELECT ITEMID FROM ITEMMAST I WHERE '+@ITEMFILTER                     
IF @COUNTERIDS <> 'ALL' SELECT @QRY =@QRY+' INSERT INTO #ITEMCTR(CTRID) SELECT ITEMCTRID FROM ITEMCOUNTER WHERE  ITEMCTRID IN ('''+@COUNTERIDS+''')'                      
IF @DESIGNERIDS <> 'ALL' SELECT @QRY =@QRY+' INSERT INTO #DESIGNERS(DESIGNERID) SELECT DESIGNERID FROM DESIGNER WHERE  DESIGNERID IN ('''+@DESIGNERIDS+''')'                      
EXEC(@QRY)                
SET @ITEMFILTER='' /** DESIGNER FILTER**/                 
SET @ITEMFILTER=  ' T.ITEMID IN(SELECT ITEMID FROM TEMPTABLEDB..TEMPITEMIDS)'                
SET @DESFILTER='' /** DESIGNER FILTER**/                 
IF @DESIGNERIDS <> '' SET @DESFILTER= @DESFILTER + 'AND T.DESIGNERID IN(SELECT DESIGNERID FROM #DESIGNERS)'                
SET @TAGFILTER='' /** TAG FILTER**/                 
IF @ITEMTYPEIDS <> '' SET @TAGFILTER= @TAGFILTER + 'AND T.ITEMTYPEID IN('+ @ITEMTYPEIDS +')'                
SET @COUNTERIDS = REPLACE(@COUNTERIDS,',',''',''')                  
IF @COUNTERIDS <> '' SET @TAGFILTER= @TAGFILTER + 'AND T.ITEMCTRID IN(SELECT CTRID FROM #ITEMCTR)'                
SET @COSTIDS = REPLACE(@COSTIDS,',',''',''')                  
IF @COSTIDS <> '' SET @TAGFILTER= @TAGFILTER + 'AND T.COSTID IN('''+ @COSTIDS+''')'             
SET @COMPANYID = REPLACE(@COMPANYID,',',''',''')                  
IF @COMPANYID<>'' SET @TAGFILTER= @TAGFILTER + ' AND T.COMPANYID IN('''+ @COMPANYID +''')'                
SELECT @SQLQRY =  CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTK'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTK'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'CTRANSFER1'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'CTRANSFER1'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'CTRANSFER'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'CTRANSFER'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTKVIEW'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTKVIEW'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTKFIN'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTKFIN'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'RANGEMAST'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'RANGEMAST'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + ' CREATE TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP VARCHAR(20),COSTID VARCHAR(10),DESIGNERID INT,ITEMTYPEID INT,ITEMCTRID INT,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ITEMGROUP VARCHAR(20),TITEMID INT,ITEMID INT,SUBITEMID INT,TAGS INT,PCS INT,GRSWT DECIMAL(15,3),NETWT DECIMAL(15,3),EXTRAWT DECIMAL(15,3),VALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SALVALUE DECIMAL(15,2),SNO VARCHAR(20),RECISS VARCHAR(20),STONE VARCHAR(20),STYLENO VARCHAR(20),RATE DECIMAL(15,2),DIAPCS INT,DIAWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' STNPCS INT,STNWT DECIMAL(15,3),ITEMSIZEID INT NULL,TAGNO VARCHAR(20))'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + ' CREATE TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK (SEP VARCHAR(20),COSTID VARCHAR(10),DESIGNERID INT,ITEMTYPEID INT,ITEMCTRID INT,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ITEMGROUP VARCHAR(20),TITEMID INT,ITEMID INT,SUBITEMID INT,TAGS INT,PCS INT,GRSWT DECIMAL(15,3),NETWT DECIMAL(15,3),EXTRAWT DECIMAL(15,3),VALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SALVALUE DECIMAL(15,2),SNO VARCHAR(20),RECISS VARCHAR(20),STONE VARCHAR(20),STYLENO VARCHAR(20),RATE DECIMAL(15,2),DIAPCS INT,DIAWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' STNPCS INT,STNWT DECIMAL(15,3),ITEMSIZEID INT NULL,TAGNO VARCHAR(20))'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + ' CREATE TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'CTRANSFER (SEP VARCHAR(20),COSTID VARCHAR(10),DESIGNERID INT,ITEMTYPEID INT,ITEMCTRID INT,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ITEMGROUP VARCHAR(20),TITEMID INT,ITEMID INT,SUBITEMID INT,TAGS INT,PCS INT,GRSWT DECIMAL(15,3),NETWT DECIMAL(15,3),EXTRAWT DECIMAL(15,3),VALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SALVALUE DECIMAL(15,2),SNO VARCHAR(20),RECISS VARCHAR(20),STONE VARCHAR(20),STYLENO VARCHAR(20),RATE DECIMAL(15,2),DIAPCS INT,DIAWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' STNPCS INT,STNWT DECIMAL(15,3),ITEMSIZEID INT NULL,TAGNO VARCHAR(20))'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
IF @TAGTYPE='T' OR @TAGTYPE='B'                
BEGIN                
/* GETTING OPENING,ISSUE,RECEIPT FROM ITEMTAG */                
SELECT @SQLQRY =  CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + ' SELECT * INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK FROM ITEMTAG AS T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE '                
SELECT @SQLQRY = @SQLQRY + @ITEMFILTER                
SELECT @SQLQRY = @SQLQRY + @DESFILTER                
SELECT @SQLQRY = @SQLQRY + @TAGFILTER                     
SELECT @SQLQRY = @SQLQRY + @REGORDFILTER                  
/* SELECT @SQLQRY = @SQLQRY +' AND T.SNO NOT IN(SELECT TAGSNO FROM CTRANSFER)' UPDATE SURESH.R 2024-07-12 */              
SELECT @SQLQRY = @SQLQRY +' AND TOFLAG<>''TR'' AND NARRATION<>''TAG SPLITTED'' AND ISNULL(T.OLDTAGNO,'''')='''''           
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT * FROM CITEMTAG AS T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE '                
SELECT @SQLQRY = @SQLQRY + @ITEMFILTER                
SELECT @SQLQRY = @SQLQRY + @DESFILTER                
SELECT @SQLQRY = @SQLQRY + @TAGFILTER                     
SELECT @SQLQRY = @SQLQRY + @REGORDFILTER           
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT * FROM MITEMTAG AS T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE '                
SELECT @SQLQRY = @SQLQRY + @ITEMFILTER                
SELECT @SQLQRY = @SQLQRY + @DESFILTER                
SELECT @SQLQRY = @SQLQRY + @TAGFILTER                     
SELECT @SQLQRY = @SQLQRY + @REGORDFILTER               
/* SELECT @SQLQRY = @SQLQRY +' AND T.SNO NOT IN(SELECT TAGSNO FROM CTRANSFER)' */                 
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
IF @TRANONLY<>'Y'                
BEGIN                    
/* OPENING*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + '  SELECT ''OPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(VARCHAR(15),SNO)SNO,''''RECISS,0 STONE,T.STYLENO,CASE WHEN RATE <> 0 THEN RATE ELSE BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK AS T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'' '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE ' + @RECDATE + ' < '''+@FRMDATE + ''' AND IT.STOCKTYPE=''T'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND (ISSDATE >= '''+@FRMDATE+''' OR ISSDATE IS NULL)'                
SELECT @SQLQRY = @SQLQRY +' AND T.SNO NOT IN (SELECT TAGSNO FROM CTRANSFER)'                 
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY               
/* MITEMTAG OPENING*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + '  SELECT ''OPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(VARCHAR(15),SNO)SNO,''''RECISS,0 STONE,T.STYLENO,CASE WHEN RATE <> 0 THEN RATE ELSE BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK AS T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'' '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE ' + @RECDATE + ' < '''+@FRMDATE + ''' AND IT.STOCKTYPE=''T'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND (ISSDATE >= '''+@FRMDATE+''' OR ISSDATE IS NULL)'                
SELECT @SQLQRY = @SQLQRY +' AND T.SNO IN (SELECT SNO FROM MITEMTAG)'                 
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/*CTRANSFER OPENING */                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + '  SELECT ''CTRANOPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,I.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'             
   
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(VARCHAR(15),T.SNO)SNO,''''RECISS,0 STONE,T.STYLENO,CASE WHEN RATE <> 0 THEN RATE ELSE BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,T.TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM ITEMTAG  T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN CTRANSFER  AS I ON I.TAGSNO = T.SNO AND I.ITEMID = T.ITEMID AND I.TAGNO = T.TAGNO AND ISNULL(I.COSTID,'''')=ISNULL(T.COSTID,'''') AND (I.ISSDATE IS NULL OR I.ISSDATE >= '''+@FRMDATE + ''') AND I.RECDATE  
<  '''+@FRMDATE + ''''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE (T.ISSDATE IS NULL  OR T.ISSDATE >=  '''+@FRMDATE + ''') AND IT.STOCKTYPE=''T'' AND T.RECDATE < '''+@FRMDATE + ''' AND '                    
SELECT @SQLQRY = @SQLQRY + @ITEMFILTER                
SELECT @SQLQRY = @SQLQRY + @DESFILTER                
SELECT @SQLQRY = @SQLQRY + @TAGFILTER                     
SELECT @SQLQRY = @SQLQRY + @REGORDFILTER               
SELECT @SQLQRY = @SQLQRY +'  AND TOFLAG<>''TR'' AND ISNULL(T.OLDTAGNO,'''')='''''            
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/* APPROVAL OPENING*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,T.SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''APPOPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(VARCHAR(15),SNO)SNO,''''RECISS,0 STONE,T.STYLENO,CASE WHEN RATE <> 0 THEN RATE ELSE BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS ,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK AS T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' LEFT JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE ' + @RECDATE + ' < '''+@FRMDATE + ''' AND IT.STOCKTYPE=''T'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND (ISSDATE >= '''+@FRMDATE+''' OR ISSDATE IS NULL) '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND (TAGNO IN (SELECT TAGNO FROM '+ @DBNAME + '..ISSUE WHERE TRANDATE < '''+@FRMDATE+''' AND TRANTYPE = ''AI''AND (REFDATE IS NULL OR REFDATE>='''+ @FRMDATE + ''') AND ISNULL(CANCEL,'''') = '''' AND ISNULL(COSTID,''
'')=ISNULL(T.COSTID,'''') AND ISNULL(ITEMID,'''')=ISNULL(T.ITEMID,''''))'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' OR TAGNO IN (SELECT TAGNO FROM '+ @DBNAME + '..APPISSUE WHERE TRANDATE < '''+@FRMDATE+''' AND TRANTYPE = ''AI''  AND (REFDATE IS NULL OR REFDATE>='''+ @FRMDATE + ''') AND ISNULL(CANCEL,'''') = '''' AND ISNULL(COSTID
,'''')=ISNULL(T.COSTID,'''') AND ISNULL(ITEMID,'''')=ISNULL(T.ITEMID,'''')))'                
SELECT @SQLQRY = @SQLQRY +' AND T.SNO NOT IN (SELECT TAGSNO FROM CTRANSFER WHERE RECDATE='''+@FRMDATE + ''')'                 
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/*ISSUE*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT CASE WHEN TOFLAG=''MI'' THEN ''ISS'' ELSE ''ISS'' END SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 
0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.SNO,''''RECISS,0 STONE,T.STYLENO,CASE WHEN RATE <> 0 THEN RATE ELSE BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'        BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE ' + @RECDATE + ' <= '''+@TODATE + ''' AND ISSDATE BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE + ''' AND TOFLAG<>''TR'' AND IT.STOCKTYPE=''T'''                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
END               
/*SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'*/                
/*RECEIPT*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''REC''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'           
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SNO,'''' RECISS,0 STONE,T.STYLENO,CASE WHEN RATE <> 0 THEN RATE ELSE BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE ' + @RECDATE + ' BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE + ''' AND TOFLAG<>''TR'' AND IT.STOCKTYPE=''T'''                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''CTRANREC''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,I.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'              
  
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.SNO,'''' RECISS,0 STONE,T.STYLENO,CASE WHEN RATE <> 0 THEN RATE ELSE BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'      
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,T.TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM ITEMTAG T'                             
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN CTRANSFER  AS I ON I.TAGSNO = T.SNO AND I.ITEMID = T.ITEMID AND I.TAGNO = T.TAGNO AND ISNULL(I.COSTID,'''')=ISNULL(T.COSTID,'''') AND I.RECDATE  BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE + ''' '         
 
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHERE IT.STOCKTYPE=''T'' AND T.RECDATE < '''+@FRMDATE + ''' AND '                    
SELECT @SQLQRY = @SQLQRY + @ITEMFILTER                
SELECT @SQLQRY = @SQLQRY + @DESFILTER                
SELECT @SQLQRY = @SQLQRY + @TAGFILTER                     
SELECT @SQLQRY = @SQLQRY + @REGORDFILTER            
SELECT @SQLQRY = @SQLQRY +'  AND TOFLAG<>''TR'' AND ISNULL(T.OLDTAGNO,'''')='''''            
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
IF @TRANONLY<>'Y'                
BEGIN                
/** APPORVAL **/                  
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                        
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''APPISS''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.SNO,'''' RECISS,0 STONE,T.STYLENO,CASE WHEN T.RATE <> 0 THEN T.RATE ELSE T.BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,T.TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN '+ @DBNAME + '..APPISSUE AS I ON'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' I.TRANDATE BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE + ''' AND IT.STOCKTYPE=''T'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(I.CANCEL,'''') = '''''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND I.ITEMID = T.ITEMID AND I.TAGNO = T.TAGNO AND ISNULL(I.COSTID,'''')=ISNULL(T.COSTID,'''')'                 
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND I.TRANTYPE = ''AI'' AND (T.ISSDATE IS NULL OR T.ISSDATE >= I.TRANDATE) '                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/*SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''APPISS''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.SNO,'''' RECISS,0 STONE,T.STYLENO,CASE WHEN T.RATE <> 0 THEN T.RATE ELSE T.BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS ,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,T.TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN '+ @DBNAME + '..ISSUE AS I ON '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' I.TRANDATE BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE + ''' AND IT.STOCKTYPE=''T'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(I.CANCEL,'''') = '''''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND I.ITEMID = T.ITEMID AND I.TAGNO = T.TAGNO AND ISNULL(I.COSTID,'''')=ISNULL(T.COSTID,'''')'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND I.TRANTYPE = ''AI'' AND (T.ISSDATE IS NULL OR T.ISSDATE >= I.TRANDATE) '                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/*SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1 (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,TAGS,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT,ITEMSIZEID,TAGNO)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''APPREC''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,case when isnull(t.pcs,0) > 0 then T.PCS/T.PCS else 0 end,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,(SELECT SUM(ISNULL(STNAMT,0)) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO) AS VALUE,SALVALUE'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.SNO,'''' RECISS,0 STONE,T.STYLENO,CASE WHEN T.RATE <> 0 THEN T.RATE ELSE T.BOARDRATE END AS RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE  IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,SIZEID,T.TAGNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMSTOCK T'              
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN '+ @DBNAME + '..RECEIPT AS I ON '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' I.TRANDATE BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE + ''' AND IT.STOCKTYPE=''T'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND (T.ISSDATE IS NULL OR T.ISSDATE >= I.TRANDATE) AND ISNULL(I.CANCEL,'''') = '''''             
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND I.ITEMID = T.ITEMID AND I.TAGNO = T.TAGNO AND ISNULL(I.COSTID,'''')=ISNULL(T.COSTID,'''')'                 
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND I.TRANTYPE = ''AR'''                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
END                
END             
IF @TAGTYPE='N' OR @TAGTYPE='B'                
BEGIN                
/* GETTING OPENING,ISSUE,RECEIPT FROM ITEMNONTAG */                
SELECT @SQLQRY =  CHAR(13) + ' IF OBJECT_ID(''TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK'')IS NOT NULL DROP TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + ' SELECT * INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK FROM ITEMNONTAG AS T WHERE '                
SELECT @SQLQRY = @SQLQRY + @ITEMFILTER                
SELECT @SQLQRY = @SQLQRY + @DESFILTER                      
SELECT @SQLQRY = @SQLQRY + @TAGFILTER                 
SELECT @SQLQRY = @SQLQRY + @REGORDFILTER                  
PRINT @SQLQRY         
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT)'                
SELECT @SQLQRY =  @SQLQRY + ' SELECT ''OPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID '                
SELECT @SQLQRY =  @SQLQRY + ' ,T.PCS,T.GRSWT,T.NETWT'                        
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,2),NULL)VALUE,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CASE WHEN IT.CALTYPE=''W'' AND RECISS=''R'' THEN (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0))'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHEN IT.CALTYPE=''R'' AND RECISS=''R'' THEN (ISNULL(T.RATE,0)*ISNULL(T.PCS,0)) ELSE (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0)) END SALVALUE,SNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,RECISS,0 STONE,CONVERT(VARCHAR(20),PACKETNO)STYLENO,RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK T '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID WHERE RECDATE<'''+@FRMDATE + ''' AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(APPROVAL,'''') <> ''A'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(CANCEL,'''') = '''' AND T.RECISS=''R'''                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/*SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''APPOPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,2),NULL)VALUE,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CASE WHEN IT.CALTYPE=''W'' THEN (ISNULL(T.RATE,0)*(ISNULL(T.NETWT,0)*(-1)))'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHEN IT.CALTYPE=''R''  THEN (ISNULL(T.RATE,0)*(ISNULL(T.PCS,0)*(-1))) ELSE (ISNULL(T.RATE,0)*(ISNULL(T.NETWT,0)*(-1))) END SALVALUE,SNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,RECISS,0 STONE,CONVERT(VARCHAR(20),PACKETNO)STYLENO,RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN        
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK T '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID WHERE RECDATE < '''+@FRMDATE + ''' AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(APPROVAL,'''') <> ''A'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(CANCEL,'''') = '''' AND T.RECISS=''I'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'                
/** APPORVAL **/                    
SELECT @SQLQRY =  @SQLQRY + ' SELECT ''APPOPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,2),NULL)VALUE,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CASE WHEN IT.CALTYPE=''W'' AND RECISS=''R'' THEN (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0))'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHEN IT.CALTYPE=''R'' AND RECISS=''R'' THEN (ISNULL(T.RATE,0)*ISNULL(T.PCS,0)) ELSE (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0)) END SALVALUE,SNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,RECISS,0 STONE,CONVERT(VARCHAR(20),PACKETNO)STYLENO,RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK T '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID WHERE RECDATE<'''+@FRMDATE + ''' AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(APPROVAL,'''') = ''A'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(CANCEL,'''') = '''' AND T.RECISS=''R'' AND T.ISSTYPE=''AR'''                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/*SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'*/                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK (SEP,COSTID,DESIGNERID,T.ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT ''APPOPE''SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,2),NULL)VALUE,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CASE WHEN IT.CALTYPE=''W'' THEN (ISNULL(T.RATE,0)*(ISNULL(T.NETWT,0)*(-1)))'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHEN IT.CALTYPE=''R''  THEN (ISNULL(T.RATE,0)*(ISNULL(T.PCS,0)*(-1))) ELSE (ISNULL(T.RATE,0)*(ISNULL(T.NETWT,0)*(-1))) END SALVALUE,SNO'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,RECISS,0 STONE,CONVERT(VARCHAR(20),PACKETNO)STYLENO,RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK T '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID WHERE RECDATE < '''+@FRMDATE + ''' AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(APPROVAL,'''') = ''A'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(CANCEL,'''') = '''' AND T.RECISS=''I''  AND T.ISSTYPE=''AI'''                
SELECT @SQLQRY = @SQLQRY + @TAGFILTER                 
SELECT @SQLQRY = @SQLQRY + @REGORDFILTER                  
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT CASE WHEN ISNULL(APPROVAL,'''') = ''A'' THEN ''APPISS'' ELSE ''ISS'' END AS SEP'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,2),NULL)VALUE,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CASE WHEN IT.CALTYPE=''W'' THEN (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0))'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHEN IT.CALTYPE=''R'' THEN (ISNULL(T.RATE,0)*ISNULL(T.PCS,0)) ELSE (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0)) END SALVALUE,SNO,''R''RECISS,0 STONE,CONVERT(VARCHAR(20),PACKETNO)STYLENO,RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'             
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK T '                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' INNER JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID AND ISNULL(ACTIVE,'''') = ''Y'' AND ISNULL(STOCKREPORT,'''') = ''Y'' WHERE RECDATE BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE +'''AND RECISS = ''I'''                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(CANCEL,'''') = '''''                
/*SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'*/                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
SELECT @SQLQRY =  CHAR(13) + 'INSERT INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK (SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,TITEMID,ITEMID,SUBITEMID,PCS,GRSWT,NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,EXTRAWT,VALUE,SALVALUE,SNO,RECISS,STONE,STYLENO,RATE,DIAPCS,DIAWT,STNPCS,STNWT)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT CASE WHEN ISNULL(APPROVAL,'''') = ''A'' THEN ''APPREC'' ELSE ''REC'' END AS SEP'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,T.PCS,T.GRSWT,T.NETWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,2),NULL)VALUE,'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CASE WHEN IT.CALTYPE=''W'' THEN (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0))'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' WHEN IT.CALTYPE=''R'' THEN (ISNULL(T.RATE,0)*ISNULL(T.PCS,0)) ELSE (ISNULL(T.RATE,0)*ISNULL(T.NETWT,0)) END SALVALUE,SNO,RECISS,0 STONE,CONVERT(VARCHAR(20),PACKETNO)STYLENO,RATE'                
IF @WITHDIA='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE = ''D''))) AS DIAWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)DIAWT'                
END                
IF @WITHSTONE='Y'                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNPCS) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),(SELECT SUM(STNWT) FROM ITEMNONTAGSTONE WHERE TAGSNO = T.SNO AND STNITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE DIASTONE IN(''S'',''P'')))) AS STNWT'                
END                
ELSE                
BEGIN                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNPCS'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ,CONVERT(NUMERIC(15,3),NULL)STNWT'                
END                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'TEMPITEMNONSTOCK T'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' LEFT JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID  WHERE RECDATE BETWEEN '''+@FRMDATE + ''' AND '''+@TODATE+''' AND RECISS = ''R'''        
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AND ISNULL(CANCEL,'''') = '''''                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
END                
IF @TAGTYPE='B'                
BEGIN                
SELECT @SQLQRY =  CHAR(13) + ' SELECT * INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' UNION ALL'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' SELECT * FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
END                
IF @TAGTYPE='N'                
BEGIN                
SELECT @SQLQRY =  CHAR(13) + ' SELECT * INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMNONTAGSTOCK'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
END                
IF @TAGTYPE='T'                
BEGIN                
SELECT @SQLQRY =  CHAR(13) + ' SELECT * INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTOCK1'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
END                    
IF @TRANONLY='Y'                
BEGIN                 
SELECT @QRY = ' DELETE FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTOCK1  WHERE SEP<>''REC'' '                
PRINT @QRY                
EXEC (@QRY)                
END              
--IF @ISSUEONLY='Y'                
--BEGIN                 
--SELECT @QRY = ' DELETE FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTOCK1  WHERE SEP<>''ISS'' '                
--PRINT @QRY                
--EXEC (@QRY)                
--END              
SELECT @QRY = 'SELECT (SELECT GROUPNAME FROM ITEMGROUPMAST WHERE GROUPID=X.ITEMGROUP)AS GROUPNAME'                
SELECT @QRY = @QRY + CHAR(13) + ' ,(SELECT ITEMNAME FROM ITEMMAST WHERE ITEMID = X.ITEMID)AS ITEM'                
SELECT @QRY = @QRY + CHAR(13) + '  ,(SELECT ITEMNAME FROM ITEMMAST WHERE ITEMID = X.TITEMID)AS TITEM'                
SELECT @QRY = @QRY + CHAR(13) + ' ,(SELECT SUBITEMNAME FROM SUBITEMMAST WHERE SUBITEMID = X.SUBITEMID)AS SUBITEM'                     
SELECT @QRY = @QRY + CHAR(13) + '  ,* INTO TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTKVIEW FROM ('                
IF @TAGTYPE='T' OR @TAGTYPE='B'                
BEGIN                
SELECT @QRY = @QRY + CHAR(13) + ' SELECT SEP,T.COSTID,T.DESIGNERID,T.ITEMTYPEID,T.ITEMCTRID,IT.ITEMGROUP,T.ITEMID TITEMID,T.ITEMID,T.SUBITEMID,T.TAGS,T.PCS,T.GRSWT,T.NETWT'                
SELECT @QRY = @QRY + CHAR(13) + ' ,T.EXTRAWT'                
SELECT @QRY = @QRY + CHAR(13) + ' ,T.VALUE,T.SALVALUE,0 STONE,T.DIAPCS,T.DIAWT,T.STNPCS,T.STNWT,T.STYLENO,T.RATE,ITEMSIZEID,T.TAGNO FROM TEMPTABLEDB..TEMP' + @SYSTEMID + 'ITEMSTOCK1 T'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN ITEMMAST AS IT ON T.ITEMID=IT.ITEMID '                      
END                
IF @TAGTYPE='B' SELECT @QRY = @QRY + CHAR(13) + ' UNION ALL'                
IF @TAGTYPE='N' OR @TAGTYPE='B'                
BEGIN                
SELECT @QRY = @QRY + CHAR(13) + '  SELECT '                
SELECT @QRY = @QRY + CHAR(13) + '  SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,ITEMID TITEMID,ITEMID,SUBITEMID,SUM(CASE WHEN RECISS = ''R'' THEN TAGS ELSE -1*TAGS END) AS  TAGS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN PCS ELSE -1*PCS END) AS PCS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN GRSWT ELSE -1*GRSWT END) AS GRSWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN NETWT ELSE -1*NETWT END) AS NETWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN EXTRAWT ELSE -1*EXTRAWT END) EXTRAWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,VALUE,SALVALUE,STONE'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN DIAPCS ELSE -1*DIAPCS END) AS DIAPCS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN DIAWT ELSE -1*DIAWT END) AS DIAWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN STNPCS ELSE -1*STNPCS END) AS STNPCS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''R'' THEN STNWT ELSE -1*STNWT END) AS STNWT,STYLENO,RATE,ITEMSIZEID,TAGNO'                
SELECT @QRY = @QRY + CHAR(13) + '  FROM TEMPTABLEDB..TEMP' + @SYSTEMID + 'ITEMNONTAGSTOCK AS X WHERE SEP<>''APPOPE'''                
SELECT @QRY = @QRY + CHAR(13) + '  GROUP BY SEP,ITEMID,TITEMID,STONE,ITEMCTRID,ITEMGROUP,DESIGNERID,ITEMTYPEID,COSTID,SUBITEMID,STYLENO,RATE,VALUE,SALVALUE,ITEMSIZEID,TAGNO'                
SELECT @QRY = @QRY + CHAR(13) + '  UNION ALL'                
SELECT @QRY = @QRY + CHAR(13) + '  SELECT SEP,COSTID,DESIGNERID,ITEMTYPEID,ITEMCTRID,ITEMGROUP,ITEMID TITEMID,ITEMID,SUBITEMID,0 TAGS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN PCS ELSE -1*PCS END) AS PCS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN GRSWT ELSE -1*GRSWT END) AS GRSWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN NETWT ELSE -1*NETWT END) AS NETWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN EXTRAWT ELSE -1*EXTRAWT END) EXTRAWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,VALUE,SALVALUE,STONE'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN DIAPCS ELSE -1*DIAPCS END) AS DIAPCS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN DIAWT ELSE -1*DIAWT END) AS DIAWT'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN STNPCS ELSE -1*STNPCS END) AS STNPCS'                
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CASE WHEN RECISS = ''I'' THEN STNWT ELSE -1*STNWT END) AS STNWT,STYLENO,RATE,ITEMSIZEID,TAGNO'                
SELECT @QRY = @QRY + CHAR(13) + '  FROM TEMPTABLEDB..TEMP' + @SYSTEMID + 'ITEMNONTAGSTOCK AS X WHERE SEP=''APPOPE'''                 
SELECT @QRY = @QRY + CHAR(13) + '  GROUP BY SEP,ITEMID,TITEMID,STONE,ITEMCTRID,ITEMGROUP,DESIGNERID,ITEMTYPEID,COSTID,SUBITEMID,STYLENO,RATE,VALUE,SALVALUE,ITEMSIZEID,TAGNO'                
END                
SELECT @QRY = @QRY + CHAR(13) + '  )X'                
PRINT @QRY                
EXEC (@QRY)                 
SELECT @QRY = ' ALTER TABLE TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW ADD RANGE VARCHAR(40) '                
PRINT @QRY                
EXEC (@QRY)                
SELECT @QRY = ' ALTER TABLE TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW ADD RANGEWT NUMERIC(15,3) '                
PRINT @QRY                
EXEC (@QRY)                
SELECT @QRY = ' SELECT * INTO TEMPTABLEDB..TEMP'+ @SYSTEMID +'RANGEMAST FROM RANGEMAST WHERE 1=1 '                
IF @RANGE <> 'ALL' AND @RANGE <> ''                
BEGIN                
SELECT @QRY = @QRY + CHAR(13) + ' AND CAPTION IN ('''+ @RANGE +''')'                   
END                
PRINT @QRY                
EXEC (@QRY)                
/*SELECT @QRY = ' UPDATE A SET A.RANGE=B.CAPTION FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS A,TEMPTABLEDB..TEMP'+ @SYSTEMID +'SELECTRANGE AS B '                
SELECT @QRY = @QRY + CHAR(13) + ' WHERE A.GRSWT BETWEEN B.FROMWEIGHT AND B.TOWEIGHT AND A.COSTID=B.COSTID AND A.ITEMID=B.ITEMID'                
SELECT @QRY = @QRY + CHAR(13) + ' AND A.SUBITEMID=B.SUBITEMID'*/                
SELECT @QRY = ' UPDATE A SET A.RANGE=B.CAPTION,A.RANGEWT=B.TOWEIGHT FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS A,TEMPTABLEDB..TEMP'+ @SYSTEMID +'RANGEMAST AS B '                
SELECT @QRY = @QRY + CHAR(13) + ' WHERE A.GRSWT BETWEEN B.FROMWEIGHT AND B.TOWEIGHT AND A.COSTID=B.COSTID AND A.ITEMID=B.ITEMID'                
SELECT @QRY = @QRY + CHAR(13) + ' AND A.SUBITEMID=B.SUBITEMID  AND A.ITEMID NOT IN (SELECT ITEMID FROM ITEMMAST WHERE METALID = ''X'')'                
SELECT @QRY = @QRY + CHAR(13)                 
SELECT @QRY = @QRY + CHAR(13) + ' UPDATE A SET A.RANGE=B.SHORTNAME FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS A,ITEMSIZE AS B '                
SELECT @QRY = @QRY + CHAR(13) + ' WHERE A.ITEMID=B.ITEMID AND A.ITEMSIZEID = B.SIZEID'                
SELECT @QRY = @QRY + CHAR(13) + ' AND A.ITEMID IN (SELECT ITEMID FROM ITEMMAST WHERE METALID = ''X'')'                
SELECT @QRY = @QRY + CHAR(13)              
SELECT @QRY = @QRY + CHAR(13) + ' UPDATE A SET A.RANGE = A.RANGE + ''-'' + B.SIZENAME FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW A '      SELECT @QRY = @QRY + CHAR(13) + ' INNER JOIN ITEMSIZE AS B ON A.ITEMID=B.ITEMID AND A.ITEMSIZEID = B.SIZEID ' 
           
SELECT @QRY = @QRY + CHAR(13) + ' WHERE ISNULL(A.ITEMSIZEID,0) <> 0 '              
PRINT 'HHHHHHH'                
PRINT @QRY                
EXEC (@QRY)                 
IF @WITHRANGEOUT='Y'                
BEGIN                
SELECT @QRY = ' UPDATE A SET A.RANGE=''ZZZZZ OUT OF RANGE'',A.RANGEWT=9999999 FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS A '                
SELECT @QRY = @QRY + CHAR(13) + ' WHERE ISNULL(A.RANGE,'''')='''' '                
PRINT @QRY                
EXEC (@QRY)                
END                
ELSE                
BEGIN                
SELECT @QRY = ' DELETE FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW '                
SELECT @QRY = @QRY + CHAR(13) + ' WHERE ISNULL(RANGE,'''')='''' '                
PRINT @QRY                
EXEC (@QRY)                
END                
SELECT @SQLQRY =  CHAR(13) + ' CREATE TABLE TEMPTABLEDB..TEMP'+@SYSTEMID+'ITEMSTK (GROUPNAME VARCHAR(20),ITEM VARCHAR(75),SUBITEM VARCHAR(200),TITEM VARCHAR(75)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ',COUNTER VARCHAR(50),DESIGNER VARCHAR(60),ITEMTYPE VARCHAR(30),COSTCENTRE  VARCHAR(30),COSTID VARCHAR(2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'ITEMID INT,SUBITEMID INT,RESULT INT,COLHEAD VARCHAR(2),STONE VARCHAR(20),DIASTONE VARCHAR(20),METALID VARCHAR(1),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'OTAGS INT,OPCS INT,OGRSWT DECIMAL(15,3),ONETWT DECIMAL(15,3),OEXTRAWT DECIMAL(15,3),OVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' OSALVALUE DECIMAL(15,2),ODIAPCS INT,ODIAWT DECIMAL(15,3), OSTNPCS INT,OSTNWT DECIMAL(15,3),'             
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'APPOTAGS INT,APPOPCS INT,APPOGRSWT DECIMAL(15,3),APPONETWT DECIMAL(15,3),APPOEXTRAWT DECIMAL(15,3),APPOVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' APPOSALVALUE DECIMAL(15,2),APPODIAPCS INT,APPODIAWT DECIMAL(15,3), APPOSTNPCS INT,APPOSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'CTRANOTAGS INT,CTRANOPCS INT,CTRANOGRSWT DECIMAL(15,3),CTRANONETWT DECIMAL(15,3),CTRANOEXTRAWT DECIMAL(15,3),CTRANOVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CTRANOSALVALUE DECIMAL(15,2),CTRANODIAPCS INT,CTRANODIAWT DECIMAL(15,3), CTRANOSTNPCS INT,CTRANOSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'RTAGS INT,RPCS INT,RGRSWT DECIMAL(15,3),RNETWT DECIMAL(15,3),REXTRAWT DECIMAL(15,3),RVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' RSALVALUE DECIMAL(15,2),RDIAPCS INT,RDIAWT DECIMAL(15,3), RSTNPCS INT,RSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'ARRTAGS INT,ARRPCS INT,ARRGRSWT DECIMAL(15,3),ARRNETWT DECIMAL(15,3),ARREXTRAWT DECIMAL(15,3),ARRVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ARRSALVALUE DECIMAL(15,2),ARRDIAPCS INT,ARRDIAWT DECIMAL(15,3), ARRSTNPCS INT,ARRSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'CRRTAGS INT,CRRPCS INT,CRRGRSWT DECIMAL(15,3),CRRNETWT DECIMAL(15,3),CRREXTRAWT DECIMAL(15,3),CRRVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CRRSALVALUE DECIMAL(15,2),CRRDIAPCS INT,CRRDIAWT DECIMAL(15,3), CRRSTNPCS INT,CRRSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'ITAGS INT,IPCS INT,IGRSWT DECIMAL(15,3),INETWT DECIMAL(15,3),IEXTRAWT DECIMAL(15,3),IVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' ISALVALUE DECIMAL(15,2),IDIAPCS INT,IDIAWT DECIMAL(15,3), ISTNPCS INT,ISTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'AIITAGS INT,AIIPCS INT,AIIGRSWT DECIMAL(15,3),AIINETWT DECIMAL(15,3),AIIEXTRAWT DECIMAL(15,3),AIIVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' AIISALVALUE DECIMAL(15,2),AIIDIAPCS INT,AIIDIAWT DECIMAL(15,3), AIISTNPCS INT,AIISTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'CIITAGS INT,CIIPCS INT,CIIGRSWT DECIMAL(15,3),CIINETWT DECIMAL(15,3),CIIEXTRAWT DECIMAL(15,3),CIIVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CIISALVALUE DECIMAL(15,2),CIIDIAPCS INT,CIIDIAWT DECIMAL(15,3), CIISTNPCS INT,CIISTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'MITAGS INT,MIPCS INT,MIGRSWT DECIMAL(15,3),MINETWT DECIMAL(15,3),MIEXTRAWT DECIMAL(15,3),MIVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' MISALVALUE DECIMAL(15,2),MIDIAPCS INT,MIDIAWT DECIMAL(15,3), MISTNPCS INT,MISTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'CTAGS INT,CPCS INT,CGRSWT DECIMAL(15,3),CNETWT DECIMAL(15,3),CEXTRAWT DECIMAL(15,3),CVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' CSALVALUE DECIMAL(15,2),CDIAPCS INT,CDIAWT DECIMAL(15,3), CSTNPCS INT,CSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'APPCTAGS INT,APPCPCS INT,APPCGRSWT DECIMAL(15,3),APPCNETWT DECIMAL(15,3),APPCEXTRAWT DECIMAL(15,3),APPCVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' APPCSALVALUE DECIMAL(15,2),APPCDIAPCS INT,APPCDIAWT DECIMAL(15,3), APPCSTNPCS INT,APPCSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + 'PTAGS INT,PPCS INT,PGRSWT DECIMAL(15,3),PNETWT DECIMAL(15,3),PEXTRAWT DECIMAL(15,3),PVALUE DECIMAL(15,2),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' PSALVALUE DECIMAL(15,2),PDIAPCS INT,PDIAWT DECIMAL(15,3), PSTNPCS INT,PSTNWT DECIMAL(15,3),'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ' STYLENO VARCHAR(20),RATE DECIMAL(15,2),PARTICULAR VARCHAR(40),RANGE VARCHAR(40),RANGEWT NUMERIC(15,2),TAGNO VARCHAR(20)'                
SELECT @SQLQRY = @SQLQRY + CHAR(13) + ')'                
PRINT @SQLQRY                
EXECUTE SP_EXECUTESQL @SQLQRY                
/*INSERT OPENING*/                
SELECT @QRY = ' INSERT INTO TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTK('                
SELECT @QRY = @QRY + 'GROUPNAME,ITEM,SUBITEM,TITEM,COUNTER,DESIGNER,COSTCENTRE,COSTID,STYLENO,'                
SELECT @QRY = @QRY + 'OTAGS,OPCS,OGRSWT,ONETWT,OEXTRAWT,ODIAPCS,ODIAWT,OSTNPCS,OSTNWT,OVALUE,OSALVALUE,'                
SELECT @QRY = @QRY + 'RATE,RANGE,RANGEWT,RESULT,COLHEAD,STONE,DIASTONE,METALID,ITEMID,PARTICULAR,TAGNO'                   
SELECT @QRY = @QRY + CHAR(13) + ' ) '                 
SELECT @QRY = @QRY + CHAR(13) + ' SELECT GROUPNAME,ITEM,SUBITEM,TITEM'                
SELECT @QRY = @QRY + CHAR(13) + ' ,C.ITEMCTRNAME COUNTER'                
SELECT @QRY = @QRY + ',D.DESIGNERNAME DESIGNER'                
SELECT @QRY = @QRY + ',CC.COSTNAME COSTCENTRE,X.COSTID,STYLENO'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN TAGS WHEN SEP = ''CTRANOPE''THEN TAGS WHEN SEP = ''APPOPE'' THEN (-1)*TAGS ELSE 0 END) AS OTAGS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN X.PCS WHEN SEP = ''CTRANOPE''THEN X.PCS WHEN SEP = ''APPOPE'' THEN (-1)*X.PCS ELSE 0 END) AS OPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN GRSWT WHEN SEP = ''CTRANOPE''THEN GRSWT WHEN SEP = ''APPOPE'' THEN (-1)*GRSWT ELSE 0 END) AS OGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN NETWT WHEN SEP = ''CTRANOPE''THEN NETWT WHEN SEP = ''APPOPE'' THEN (-1)*NETWT ELSE 0 END) AS ONETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN EXTRAWT WHEN SEP = ''CTRANOPE''THEN EXTRAWT WHEN SEP = ''APPOPE'' THEN (-1)*EXTRAWT ELSE 0 END) AS OEXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN DIAPCS WHEN SEP = ''CTRANOPE''THEN DIAPCS WHEN SEP = ''APPOPE'' THEN (-1)*DIAPCS ELSE 0 END) AS ODIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN DIAWT WHEN SEP = ''CTRANOPE''THEN DIAWT WHEN SEP = ''APPOPE'' THEN (-1)*DIAWT ELSE 0 END) AS ODIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN STNPCS WHEN SEP = ''CTRANOPE''THEN STNPCS WHEN SEP = ''APPOPE'' THEN (-1)*STNPCS ELSE 0 END) AS OSTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN STNWT WHEN SEP = ''CTRANOPE''THEN STNWT WHEN SEP = ''APPOPE'' THEN (-1)*STNWT ELSE 0 END) AS OSTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN VALUE WHEN SEP = ''CTRANOPE''THEN VALUE WHEN SEP = ''APPOPE'' THEN (-1)*VALUE ELSE 0 END) AS OVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''OPE''THEN SALVALUE WHEN SEP = ''CTRANOPE''THEN SALVALUE WHEN SEP = ''APPOPE'' THEN (-1)*SALVALUE ELSE 0 END) AS OSALVALUE'                
SELECT @QRY = @QRY + ',RATE,RANGE,RANGEWT'                
SELECT @QRY = @QRY + ',1 RESULT,'' ''COLHEAD,STONE,CASE WHEN STONE=1 THEN (SELECT DIASTONE FROM ITEMMAST WHERE ITEMID=X.ITEMID) ELSE '''' END DIASTONE'                
SELECT @QRY = @QRY + ',(SELECT METALID FROM ITEMMAST WHERE ITEMID=X.ITEMID) METALID,ITEMID'                
IF @RPTBASED='I'                
BEGIN                
SELECT @QRY = @QRY + ',ITEM AS PARTICULAR,TAGNO'                
END                
ELSE                
BEGIN                
SELECT @QRY = @QRY + ',CASE WHEN ISNULL(SUBITEM,'''') <> '''' THEN SUBITEM ELSE ITEM END AS PARTICULAR,TAGNO'                
END                
SELECT @QRY = @QRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS X'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN ITEMCOUNTER C ON C.ITEMCTRID = X.ITEMCTRID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN  DESIGNER D ON D.DESIGNERID = X.DESIGNERID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN COSTCENTRE CC ON CC.COSTID = X.COSTID'         
SELECT @QRY = @QRY + CHAR(13) + ' WHERE SEP IN (''OPE'',''APPOPE'',''CTRANOPE'')'                
SELECT @QRY = @QRY + CHAR(13) + ' GROUP BY  GROUPNAME,TITEM,ITEM,STONE,RATE,RANGE,RANGEWT,ITEMID,X.ITEMCTRID,C.ITEMCTRNAME,X.DESIGNERID,D.DESIGNERNAME,X.COSTID,CC.COSTNAME,SUBITEM,STYLENO,ITEMID,TAGNO'                
IF @RPTBASED<>'I'                
SELECT @QRY = @QRY + CHAR(13) + ' ,SUBITEM'                
PRINT 'AAAAAA'                
PRINT @QRY                
EXEC (@QRY)                
/*INSERT RECEIPT*/                
SELECT @QRY = ' INSERT INTO TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTK('                
SELECT @QRY = @QRY + 'GROUPNAME,ITEM,SUBITEM,TITEM,COUNTER,DESIGNER,COSTCENTRE,COSTID,STYLENO,'                
SELECT @QRY = @QRY + 'RTAGS,RPCS,RGRSWT,RNETWT,REXTRAWT,RDIAPCS,RDIAWT,RSTNPCS,RSTNWT,RVALUE,RSALVALUE,'                
SELECT @QRY = @QRY + 'ARRTAGS,ARRPCS,ARRGRSWT,ARRNETWT,ARREXTRAWT,ARRDIAPCS,ARRDIAWT,ARRSTNPCS,ARRSTNWT,ARRVALUE,ARRSALVALUE,'                
SELECT @QRY = @QRY + 'CRRTAGS,CRRPCS,CRRGRSWT,CRRNETWT,CRREXTRAWT,CRRDIAPCS,CRRDIAWT,CRRSTNPCS,CRRSTNWT,CRRVALUE,CRRSALVALUE,'                
SELECT @QRY = @QRY + 'RATE,RANGE,RANGEWT,RESULT,COLHEAD,STONE,DIASTONE,METALID,ITEMID,PARTICULAR,TAGNO'                     
SELECT @QRY = @QRY + CHAR(13) + ' )'                 
SELECT @QRY =  @QRY+' SELECT GROUPNAME,ITEM,SUBITEM,TITEM'                
SELECT @QRY = @QRY + CHAR(13) + ' ,C.ITEMCTRNAME COUNTER'                
SELECT @QRY = @QRY + ',D.DESIGNERNAME DESIGNER '                
SELECT @QRY = @QRY + ',CC.COSTNAME COSTCENTRE,X.COSTID,STYLENO'                
DECLARE @REC VARCHAR(100)                
SET @REC='''REC'''                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN TAGS ELSE 0 END) AS RTAGS'          
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN X.PCS ELSE 0 END) AS RPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN GRSWT ELSE 0 END) AS RGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN NETWT ELSE 0 END) AS RNETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN EXTRAWT ELSE 0 END) AS REXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN DIAPCS ELSE 0 END) AS RDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN DIAWT ELSE 0 END) AS RDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN STNPCS ELSE 0 END) AS RSTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN STNWT ELSE 0 END) AS RSTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN VALUE ELSE 0 END) AS RVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@REC+')THEN SALVALUE ELSE 0 END) AS RSALVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN TAGS ELSE 0 END) AS ARRTAGS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN X.PCS ELSE 0 END) AS ARRPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN GRSWT ELSE 0 END) AS ARRGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN NETWT ELSE 0 END) AS ARRNETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN EXTRAWT ELSE 0 END) AS ARREXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN DIAPCS ELSE 0 END) AS ARRDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN DIAWT ELSE 0 END) AS ARRDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN STNPCS ELSE 0 END) AS ARRSTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN STNWT ELSE 0 END) AS ARRSTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN VALUE ELSE 0 END) AS ARRVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPREC''THEN SALVALUE ELSE 0 END) AS ARRSALVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN TAGS ELSE 0 END) AS CRTAGS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN X.PCS ELSE 0 END) AS CRRPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN GRSWT ELSE 0 END) AS CRRGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN NETWT ELSE 0 END) AS CRRNETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN EXTRAWT ELSE 0 END) AS CRREXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN DIAPCS ELSE 0 END) AS CRRDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN DIAWT ELSE 0 END) AS CRRDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN STNPCS ELSE 0 END) AS CRRSTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN STNWT ELSE 0 END) AS CRRSTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN VALUE ELSE 0 END) AS CRRVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANREC''THEN SALVALUE ELSE 0 END) AS CRRSALVALUE'                
SELECT @QRY = @QRY + ',RATE,RANGE,RANGEWT'                
SELECT @QRY = @QRY + ',1 RESULT,'' ''COLHEAD,STONE,CASE WHEN STONE=1 THEN (SELECT DIASTONE FROM ITEMMAST WHERE ITEMID=X.ITEMID) ELSE '''' END DIASTONE'                
SELECT @QRY = @QRY + ',(SELECT METALID FROM ITEMMAST WHERE ITEMID=X.ITEMID) METALID,ITEMID'                
IF @RPTBASED='I'                
BEGIN                
SELECT @QRY = @QRY + ',ITEM AS PARTICULAR,TAGNO'                
END                
ELSE                
BEGIN                
SELECT @QRY = @QRY + ',CASE WHEN ISNULL(SUBITEM,'''') <> '''' THEN SUBITEM ELSE ITEM END AS PARTICULAR,TAGNO'                
END                
SELECT @QRY = @QRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS X'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN ITEMCOUNTER C ON C.ITEMCTRID = X.ITEMCTRID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN DESIGNER D ON D.DESIGNERID = X.DESIGNERID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN COSTCENTRE CC ON CC.COSTID = X.COSTID'                
SELECT @QRY = @QRY + CHAR(13) + ' WHERE SEP IN (''REC'',''APPREC'',''CTRANREC'')'                 
SELECT @QRY = @QRY + CHAR(13) + ' GROUP BY  GROUPNAME,TITEM,ITEM,STONE,RATE,RANGE,RANGEWT,ITEMID,X.ITEMCTRID,C.ITEMCTRNAME,X.DESIGNERID,D.DESIGNERNAME,X.COSTID,CC.COSTNAME,SUBITEM,STYLENO,ITEMID,TAGNO'                
IF @RPTBASED<>'I'                
SELECT @QRY = @QRY + CHAR(13) + ' ,SUBITEM'                
PRINT @QRY                
EXEC (@QRY)                 
/*INSERT ISSUE*/                
SELECT @QRY = ' INSERT INTO TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTK('                
SELECT @QRY = @QRY + 'GROUPNAME,ITEM,SUBITEM,TITEM,COUNTER,DESIGNER,COSTCENTRE,COSTID,STYLENO,'                
SELECT @QRY = @QRY + 'ITAGS,IPCS,IGRSWT,INETWT,IEXTRAWT,IDIAPCS,IDIAWT,ISTNPCS,ISTNWT,IVALUE,ISALVALUE,'                
SELECT @QRY = @QRY + 'AIITAGS,AIIPCS,AIIGRSWT,AIINETWT,AIIEXTRAWT,AIIDIAPCS,AIIDIAWT,AIISTNPCS,AIISTNWT,AIIVALUE,AIISALVALUE,'                
SELECT @QRY = @QRY + 'CIITAGS,CIIPCS,CIIGRSWT,CIINETWT,CIIEXTRAWT,CIIDIAPCS,CIIDIAWT,CIISTNPCS,CIISTNWT,CIIVALUE,CIISALVALUE,'                
SELECT @QRY = @QRY + 'MITAGS,MIPCS,MIGRSWT,MINETWT,MIEXTRAWT,MIDIAPCS,MIDIAWT,MISTNPCS,MISTNWT,MIVALUE,MISALVALUE,'                
SELECT @QRY = @QRY + 'RATE,RANGE,RANGEWT,RESULT,COLHEAD,STONE,DIASTONE,METALID,ITEMID,PARTICULAR,TAGNO'                 
SELECT @QRY = @QRY + CHAR(13) + ' )'                 
SELECT @QRY =  @QRY+' SELECT GROUPNAME,ITEM,SUBITEM,TITEM'                
SELECT @QRY = @QRY + CHAR(13) + ' ,C.ITEMCTRNAME COUNTER'                
SELECT @QRY = @QRY + ',D.DESIGNERNAME DESIGNER'                
SELECT @QRY = @QRY + ',CC.COSTNAME COSTCENTRE,X.COSTID,STYLENO'                
DECLARE @ISS VARCHAR(50)                
SET @ISS='''ISS'''                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN TAGS ELSE 0 END) AS ITAGS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN X.PCS ELSE 0 END) AS IPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN GRSWT ELSE 0 END) AS IGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN NETWT ELSE 0 END) AS INETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN EXTRAWT ELSE 0 END) AS IEXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN DIAPCS ELSE 0 END) AS IDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN DIAWT ELSE 0 END) AS IDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN STNPCS ELSE 0 END) AS ISTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN STNWT ELSE 0 END) AS ISTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN VALUE ELSE 0 END) AS IVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN ('+@ISS+')THEN SALVALUE ELSE 0 END) AS ISALVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN TAGS ELSE 0 END) AS AITAG'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN X.PCS ELSE 0 END) AS AIIPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN GRSWT ELSE 0 END) AS AIIGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN NETWT ELSE 0 END) AS AIINETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN EXTRAWT ELSE 0 END) AS AIIEXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN DIAPCS ELSE 0 END) AS AIIDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN DIAWT ELSE 0 END) AS AIIDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN STNPCS ELSE 0 END) AS AIISTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN STNWT ELSE 0 END) AS AIISTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN VALUE ELSE 0 END) AS AIIVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''APPISS''THEN SALVALUE ELSE 0 END) AS AIISALVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN TAGS ELSE 0 END) AS CITAG'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN X.PCS ELSE 0 END) AS CIIPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN GRSWT ELSE 0 END) AS CIIGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN NETWT ELSE 0 END) AS CIINETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN EXTRAWT ELSE 0 END) AS CIIEXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN DIAPCS ELSE 0 END) AS CIIDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN DIAWT ELSE 0 END) AS CIIDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN STNPCS ELSE 0 END) AS CIISTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN STNWT ELSE 0 END) AS CIISTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN VALUE ELSE 0 END) AS CIIVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''CTRANISS''THEN SALVALUE ELSE 0 END) AS CIISALVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN TAGS ELSE 0 END) AS MITAG'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN X.PCS ELSE 0 END) AS MIIPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN GRSWT ELSE 0 END) AS MIIGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN NETWT ELSE 0 END) AS MIINETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN EXTRAWT ELSE 0 END) AS MIEXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN DIAPCS ELSE 0 END) AS MIDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN DIAWT ELSE 0 END) AS MIDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN STNPCS ELSE 0 END) AS MISTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN STNWT ELSE 0 END) AS MISTNWT'            
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN VALUE ELSE 0 END) AS MIVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP = ''MIS''THEN SALVALUE ELSE 0 END) AS MISALVALUE'                
SELECT @QRY = @QRY + ',RATE,RANGE,RANGEWT'                
SELECT @QRY = @QRY + ',1 RESULT,'' ''COLHEAD,STONE,CASE WHEN STONE=1 THEN (SELECT DIASTONE FROM ITEMMAST WHERE ITEMID=X.ITEMID) ELSE '''' END DIASTONE'                
SELECT @QRY = @QRY + ',(SELECT METALID FROM ITEMMAST WHERE ITEMID=X.ITEMID) METALID,ITEMID'                
IF @RPTBASED='I'                
BEGIN                
SELECT @QRY = @QRY + ',ITEM AS PARTICULAR,TAGNO'                
END                
ELSE                
BEGIN                
SELECT @QRY = @QRY + ',CASE WHEN ISNULL(SUBITEM,'''') <> '''' THEN SUBITEM ELSE ITEM END AS PARTICULAR,TAGNO'                
END                
SELECT @QRY = @QRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS X'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN ITEMCOUNTER C ON C.ITEMCTRID = X.ITEMCTRID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN DESIGNER D ON D.DESIGNERID = X.DESIGNERID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN COSTCENTRE CC ON CC.COSTID = X.COSTID'                 
SELECT @QRY = @QRY + CHAR(13) + ' WHERE SEP IN (''ISS'',''APPISS'',''MIS'',''CTRANISS'')'                 
SELECT @QRY = @QRY + CHAR(13) + ' GROUP BY  GROUPNAME,TITEM,ITEM,STONE,RATE,RANGE,RANGEWT,ITEMID,X.ITEMCTRID,C.ITEMCTRNAME,X.DESIGNERID,D.DESIGNERNAME,X.COSTID,CC.COSTNAME,SUBITEM,STYLENO,ITEMID,TAGNO'
IF @RPTBASED<>'I'                
SELECT @QRY = @QRY + CHAR(13) + ' ,SUBITEM'                
PRINT @QRY                
EXEC (@QRY)                 
/*INSERT CLOSING*/                
SELECT @QRY = ' INSERT INTO TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTK('                
SELECT @QRY = @QRY + 'GROUPNAME,ITEM,SUBITEM,TITEM,COUNTER,DESIGNER,COSTCENTRE,COSTID,STYLENO,'                
SELECT @QRY = @QRY + 'CTAGS,CPCS,CGRSWT,CNETWT,CEXTRAWT,CDIAPCS,CDIAWT,CSTNPCS,CSTNWT,CVALUE,CSALVALUE,'                
SELECT @QRY = @QRY + 'RATE,RANGE,RANGEWT,RESULT,COLHEAD,STONE,DIASTONE,METALID,ITEMID,PARTICULAR,TAGNO '                  
SELECT @QRY = @QRY + CHAR(13) + ' ) '                
SELECT @QRY =  @QRY+' SELECT GROUPNAME,ITEM,SUBITEM,TITEM'                
SELECT @QRY = @QRY + CHAR(13) + ' ,C.ITEMCTRNAME COUNTER'                
SELECT @QRY = @QRY + ',D.DESIGNERNAME DESIGNER'                
SELECT @QRY = @QRY + ',CC.COSTNAME COSTCENTRE,X.COSTID,STYLENO'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*TAGS WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN TAGS END) AS CTAGS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*X.PCS WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN X.PCS END) AS CPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*GRSWT WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN GRSWT END) AS CGRSWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*NETWT WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN NETWT END) AS CNETWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*EXTRAWT WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN EXTRAWT END) AS CEXTRAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*DIAPCS WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN DIAPCS END) AS CDIAPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*DIAWT WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN DIAWT END) AS CDIAWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*STNPCS WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN STNPCS END) AS CSTNPCS'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*STNWT WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN STNWT END) AS CSTNWT'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*VALUE WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN VALUE END) AS CVALUE'                
SELECT @QRY = @QRY + ',SUM(CASE WHEN SEP IN (''MIS'',''ISS'',''APPOPE'',''APPISS'',''CTRANISS'')THEN -1*SALVALUE WHEN SEP IN(''OPE'',''CTRANOPE'',''REC'',''APPREC'',''CTRANREC'') THEN SALVALUE END) AS CSALVALUE'                
SELECT @QRY = @QRY + ',RATE,RANGE,RANGEWT'                
SELECT @QRY = @QRY + ',1 RESULT,'' ''COLHEAD,STONE,CASE WHEN STONE=1 THEN (SELECT DIASTONE FROM ITEMMAST WHERE ITEMID=X.ITEMID) ELSE '''' END DIASTONE'                
SELECT @QRY = @QRY + ',(SELECT METALID FROM ITEMMAST WHERE ITEMID=X.ITEMID) METALID,ITEMID'                
IF @RPTBASED='I'                
BEGIN                
SELECT @QRY = @QRY + ',ITEM AS PARTICULAR,TAGNO'                
END                
ELSE                
BEGIN                
SELECT @QRY = @QRY + ',CASE WHEN ISNULL(SUBITEM,'''') <> '''' THEN SUBITEM ELSE ITEM END AS PARTICULAR,TAGNO'                
END                
SELECT @QRY = @QRY + CHAR(13) + ' FROM TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKVIEW AS X'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN ITEMCOUNTER C ON C.ITEMCTRID = X.ITEMCTRID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN DESIGNER D ON D.DESIGNERID = X.DESIGNERID'                
SELECT @QRY = @QRY + CHAR(13) + ' LEFT JOIN COSTCENTRE CC ON CC.COSTID = X.COSTID'                 
SELECT @QRY = @QRY + CHAR(13) + ' GROUP BY  GROUPNAME,TITEM,ITEM,STONE,RATE,RANGE,RANGEWT,ITEMID,X.ITEMCTRID,C.ITEMCTRNAME,X.DESIGNERID,D.DESIGNERNAME,X.COSTID,CC.COSTNAME,SUBITEM,STYLENO,ITEMID,TAGNO'                
IF @RPTBASED<>'I'                
SELECT @QRY = @QRY + CHAR(13) + ' ,SUBITEM'                
PRINT @QRY                
EXEC (@QRY)                
/*INSERT SUMMARY*/                
IF @RPTBASED='I'                
SELECT @QRY =' SELECT ''   ''+ REPLACE(RANGE,''ZZZZZ '','''') + ''-''  + ITEM    AS PARTICULAR'            
ELSE                
SELECT @QRY =' SELECT ''   ''+ REPLACE(RANGE,''ZZZZZ '','''') + ''-'' + SUBITEM   AS PARTICULAR' 
SELECT @QRY = @QRY + CHAR(13) + '  ,D.DESIGNERNAME,T.TAGNO,DATEDIFF(DAY,I.RECDATE,GETDATE())AGE'
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CONVERT(INT,IPCS)) IPCS,SUM(IGRSWT) IGRSWT,SUM(INETWT) INETWT'
SELECT @QRY = @QRY + CHAR(13) + '  ,SUM(CONVERT(INT,CPCS)) CPCS,SUM(CGRSWT) CGRSWT,SUM(CNETWT) CNETWT'
SELECT @QRY = @QRY + CHAR(13) + '  INTO TEMPTABLEDB..TEMP'+ @SYSTEMID +'ITEMSTKFIN'                
SELECT @QRY = @QRY + CHAR(13) + '  FROM TEMPTABLEDB..TEMP' + @SYSTEMID + 'ITEMSTK AS T'    
SELECT @QRY = @QRY + CHAR(13) + '  JOIN ITEMTAG I ON I.TAGNO = T.TAGNO'
SELECT @QRY = @QRY + CHAR(13) + '  JOIN DESIGNER D ON D.DESIGNERID = I.DESIGNERID'
SELECT @QRY = @QRY + CHAR(13) + '  GROUP BY PARTICULAR,ITEM,T.TAGNO,ITEM,SUBITEM,RANGE,RANGEWT,D.DESIGNERNAME,I.RECDATE'                
PRINT @QRY                
EXEC (@QRY)   
END